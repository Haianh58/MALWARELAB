# MALWARELAB
# REPORT



## I. Hunting
Check "Autoruns" thấy được một entry nghi ngờ được ghi vào key "Computer\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" vào ngày 23/08

![image](https://hackmd.io/_uploads/ryihQZsoC.png)

Thử jump đến entry đó để lấy hash thì không thấy file đó đâu
![image](https://hackmd.io/_uploads/ryatSbss0.png)

Sử dụng "PCHunter" để kiểm tra thì thấy được file đó đã bị "Set Hidden Attributes", ta chỉ cần set lại normal để xem file
![image](https://hackmd.io/_uploads/HJMdIWojA.png)

![image](https://hackmd.io/_uploads/rklTZ2io0.png)

## II.Forensics
### 1. Điều tra nguyên nhân cuộc tấn công
![image](https://hackmd.io/_uploads/S1z00oas0.png)

Mã độc được khởi tạo vào ngày 23/8/2024 12:06:13 AM 

Thực hiện kiểm tra Event Log từ lúc mã độc được tạo trở về trước thấy có các Event ID 100, thông báo này cho biết máy chủ MariaDB (mysqld.exe) tại đường dẫn c:\xampp\mysql\bin đang chạy port 3306 và sẵn sàng chấp nhận kết nối.
![image](https://hackmd.io/_uploads/ryUjInpjA.png)


Thực hiện kiểm tra file C:\xampp\apache\logs\access.log để kiểm tra các yêu cầu HTTP mà máy chủ web Apache 
![image](https://hackmd.io/_uploads/rJOm_npjA.png)

Vào đúng 23/8/20240 6:13 xác định được chỉ có 1 địa chỉ IP lạ là "192.168.0.118" kết nối đến server và upload file "baitap.php"
![image](https://hackmd.io/_uploads/BkD5F2poR.png)

Kiểm tra file "baitap.php" thì thấy được đây là 1 webshell thực hiện viết binary vào bin.exe và thực thi file 
![image](https://hackmd.io/_uploads/rJj0snas0.png)

![image](https://hackmd.io/_uploads/ryvt5npj0.png)

### 2. Kết luận
Sau khi kiểm tra đã xác định được rằng vào ngày 23/8/2024 lúc 06:13, một địa chỉ IP lạ, 192.168.0.118, đã kết nối đến máy chủ web Apache và tải lên một tệp có tên là baitap.php. Việc kiểm tra nội dung của tệp baitap.php cho thấy đây là một webshell, một công cụ mã độc được sử dụng để thực thi các lệnh từ xa trên máy chủ.

Webshell này đã thực hiện thao tác ghi một tệp nhị phân vào máy chủ với tên là bin.exe và tiến hành thực thi tệp này. Điều này cho thấy mã độc đã được khởi tạo và kích hoạt trên máy chủ vào cùng thời điểm.

Qua các bước điều tra, ta xác định rằng cuộc tấn công đã lợi dụng lỗ hổng upload file trong máy chủ web Apache. Sau khi tải lên webshell baitap.php, kẻ tấn công đã sử dụng nó để thực thi mã độc trực tiếp trên máy.

## III. Reverse
### 1, Thông tin

| File name               | MD5                              | Type      |
| ----------------------- | -------------------------------- | --------- |
| NvidiaGraphicDriver.exe | FA0E784F90ADB9A329644033C1C73E87 | PE 64-bit |

### 2, Luồng hoạt động của mã độc
![image](https://hackmd.io/_uploads/rk-t3jos0.png)

### 3, Phân tích chi tiết hành vi của mã độc



#### 3.1 Setup and handler exception

Mã độc sẽ list các hàm api để call tới

![image](https://hackmd.io/_uploads/rkqJdGojR.png)

```
qword_7FF7D01192A0
0	kernel32_RemoveVectoredExceptionHandler
1	kernel32_AddVectoredExceptionHandler
2	kernel32_CopyFileA
3	kernel32_CreateDirectoryA
4	kernel32_OpenProcess
5	kernel32_VirtualAllocEx
6	kernel32_WriteProcessMemory
7	kernel32_CreateThread
8	kernel32_ExitProcess
9	kernel32_WaitForSingleObject
10	kernel32_CreateToolhelp32Snapshot
11	kernel32_Thread32First
12	kernel32_Thread32Next
13	kernel32_OpenThread
14	kernel32_SuspendThread
15	kernel32_GetThreadContext
16	kernel32_SetThreadContext
17	kernel32_ResumeThread
18	kernel32_GetModuleFileNameA
19	advapi32_GetUserNameA
20	kernel32_Process32First
21	kernel32_Process32Next
22	kernel32_CloseHandle
23	kernel32_VirtualAlloc
24	kernel32_VirtualFree
25	kernel32_SetFileAttributesA 
26	kernel32_CreateRemoteThread
27	kernel32_SetThreadPriority
```

![image](https://hackmd.io/_uploads/BJg0BQjo0.png)


![image](https://hackmd.io/_uploads/rJrqVmoiA.png)

Mã độc sẽ call tới "CreateThread" và "WaitForSingleObject" để tạo thread thực hiện hành vi tấn công 
![image](https://hackmd.io/_uploads/HyIg_XioC.png)

![image](https://hackmd.io/_uploads/ByGZi7ijR.png)


Tại đây khi chương trình call tới "MEMORY[0]()" đã xảy ra ngoại lệ nên sau khi Handler được đăng ký với AddVectoredExceptionHandler, chương trình sẽ nhảy vào hàm Handler để xử lý
![image](https://hackmd.io/_uploads/HJuKpQsoR.png)

#### 3.2 Tạo thư mục và setup file attributes 

![image](https://hackmd.io/_uploads/rkPE24osR.png)
Tạo folder và Copy file "current_user\%appdata%" của user hiện tại. Chương trình sẽ call các api "GetModuleFileNameA", "CreateDirectoryA" "CopyFileA" "kernel32_SetFileAttributesA" để tạo folder   "C:\Users\REM\AppData\Roaming\Nvidia\nvidiaGraphicDriver.exe" rồi sau đó set Attributes hidden.

#### 3.3 Decrypt shellcode and Process Injection 
![image](https://hackmd.io/_uploads/BJPzgroi0.png)
![image](https://hackmd.io/_uploads/HyxeMBii0.png)

Chương trình sẽ thực hiện cấp phát memory để thực hiện lấy data shellcode và xor với `0xBCu` để decode 
![image](https://hackmd.io/_uploads/SJoKOgRsC.png)

Chương trình sẽ call tới api "CreateToolhelp32Snapshot", "Process32Next" và "Process32First" để tìm kiếm "explorer.exe" mà nó tìm thấy

![image](https://hackmd.io/_uploads/Hk5lRHsiA.png)



 
![image](https://hackmd.io/_uploads/rJqrfUojR.png)


![image](https://hackmd.io/_uploads/B1HwJUsoA.png)

Sau đó sẽ call tới "OpenProcess" "VirtualAllocEx" "WriteProcessMemory" "CreateRemoteThread" để thực hiện inject shell code vào "explorer.exe"
![image](https://hackmd.io/_uploads/HJOylIjjC.png)


#### 3.4 Anti debug
Khi shellcode được ghi vào "explorer.exe" ta sẽ thực hiện attach debug vào "explorer.exe" tuy nhiên khi debug sẽ bị crash chương trình do "explorer.exe" đầu tiên mà ta tìm kiếm là chương trình cha của ida nên ta cần bỏ qua "explorer.exe" đầu tiên và thực hiện ở cái thứ 2
![image](https://hackmd.io/_uploads/rkW7ehii0.png)

#### 3.5 Shellcode1: Create Mutex, Persistence 
![image](https://hackmd.io/_uploads/ByKD_9ij0.png)
Shellcode1 cũng list các api để call tới

```
0	kernel32_GetFileAttributesA
1	kernel32_CreateFileA
2	kernel32_ReadFile
3	kernel32_WriteFile
4	kernel32_CloseHandle
5	kernel32_CreateThread
6	kernel32_Sleep
7	kernel32_WaitForMultipleObjects
8	kernel32_GetFileSize
9	kernel32_VirtualAlloc
10	kernel32_VirtualFree
11	kernel32_GetLastError
12	kernel32_CreateDirectoryA
13	kernel32_CreateMutexA
14	kernel32_CreateProcessA
15	kernel32_SetFileAttributesA
16	advapi32_RegOpenKeyA
17	advapi32_RegSetValueExA
18	advapi32_RegCloseKey
19	advapi32_GetUserNameA

```


![image](https://hackmd.io/_uploads/BJAi3qoj0.png)

Shellcode sẽ tiếp tục gọi CreateThread, tạo mutex "KitagawaMArin" nếu như chưa có mutex này sẽ tiếp tục thực hiện tạo 2 thread

![image](https://hackmd.io/_uploads/S1yKJjjiR.png)

Tiếp tục call các api để check create folder "C:\Users\REM\AppData\Roaming\Nvidia\NvidiaGraphicDriver.exe", nếu đã bị xóa thì sẽ tạo lại. while true ở đây sẽ kiểm tra liên tục mỗi lần sau 1000s.

![image](https://hackmd.io/_uploads/ry2mzsos0.png)
shellcode call api "RegOpenKeyA()" để đăng ký key run "Computer\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" và "RegSetValueExA()" để set value "NVidia Control Panel"

#### 3.6 Shellcode2: Decrypt C2, Communicate server and Execute command
![image](https://hackmd.io/_uploads/SyoKIjjoR.png)

Shellcode2 bắt đầu thực thi tiếp tục thực hiện tạo thread bằng windowsAPI CreateThread()
```
0 kernel32.dll:kernel32_VirtualAlloc
1 kernel32.dll:kernel32_VirtualFree
2 kernel32.dll:kernel32_CloseHandle
4 kernel32.dll:kernel32_GetComputerNameA
5 kernel32.dll:kernel32_CreateProcessA
6 kernel32.dll:kernel32_Sleep
7 kernel32.dll:kernel32_CreateThread
8 wininet.dll:wininet_InternetOpenA
9 wininet.dll:wininet_InternetConnectA
10 wininet.dll:wininet_InternetOpenUrlA
11 wininet.dll:wininet_InternetReadFile
12 wininet.dll:wininet_HttpOpenRequestA
13 wininet.dll:wininet_HttpSendRequestA
14 wininet.dll:wininet_InternetCloseHandle
```

![image](https://hackmd.io/_uploads/BJ4g_jss0.png)

Shellcode sử dụng thuật toán RC4 với key là "Gojo-kun" để decrypt. 
![image](https://hackmd.io/_uploads/rkt5uiji0.png)
Sau khi decrypt ta ra được C2 là http://kitagawamarin.zya.me/ligma.txt
![image](https://hackmd.io/_uploads/HJNN9osiC.png)

Sau đó thực hiện đọc nội dung (whoami) từ file ligma.txt rồi tạo câu lệnh "cmd /c whoami" và gọi windowsAPI CreateProcessA() để thực thi câu lệnh.

![image](https://hackmd.io/_uploads/HyBv9joiR.png)


### 4, IOC 

| IOC                                                                                    | MD5                              | Type                       |
| -------------------------------------------------------------------------------------- | -------------------------------- | -------------------------- |
| NvidiaGraphicDriver.exe                                                                | FA0E784F90ADB9A329644033C1C73E87 | PE                         |
| http://kitagawamarin.zya.me/ligma.txt                                                  |                                  | URL                        |
| HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run - NVidia Control Panel |                                  | Registry key               |
| C:\Users\REM\AppData\Roaming\Nvidia\                                                   |                                  | Folder malware persistence |
|cmd /c whoami|    |execute command    |


### 5, ATT&CK Technique Mapping

| Tactic                | Technique                                                                                         | Description                                                                                  |
|-----------------------|---------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|
| Execution (TA0002)    | Command and Scripting Interpreter (T1059)                                                         | Execution of commands such as cmd /c whoami.                                               |
| Persistence (TA0003)  | Registry Run Keys / Startup Folder (T1547.001)                                                    | Modification of HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\NVidia Control Panel for persistence. |
| Privilege Escalation (TA0004) | Process Injection (T1055)                                                               | Injecting code into processes such as explorer.exe.                                        |
| Defense Evasion (TA0005) | Obfuscated Files or Information (T1027)                                                      | Using encoded or obfuscated file names and paths.                                            |
| Discovery (TA0007)    | System Information Discovery (T1082)                                                              | Using commands like whoami to gather system information.                                   |
| Command and Control (TA0011) | Application Layer Protocol (T1071)                                                      | HTTP communication with C2 server kitagawamarin.zya.me.                                    |
| Command and Control (TA0011) | Web Service (T1102)                                                                     | Using HTTP GET requests for C2 communication.                                                |
